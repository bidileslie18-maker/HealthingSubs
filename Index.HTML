<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthing Code History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <main class="w-full max-w-4xl p-8 bg-white rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-left text-gray-800 mb-6">Healthing Code Submission History</h1>
        <p class="text-left text-gray-600 mb-8">Enter your private ID to view your valid and first-time submissions.</p>

        <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-6">
            <input type="text" id="privateIdInput" placeholder="Enter your private ID" class="w-full md:w-auto p-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
            <button id="fetchButton" class="w-full md:w-auto px-6 py-3 text-lg font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                Fetch Submissions
            </button>
        </div>

        <div id="messageContainer" class="text-left text-sm font-medium h-6"></div>

        <div id="resultsContainer" class="hidden overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden shadow-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                            Healthing Code
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                            Submitted At
                        </th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">
                            First Submission
                        </th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Results will be injected here -->
                </tbody>
            </table>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const privateIdInput = document.getElementById('privateIdInput');
            const fetchButton = document.getElementById('fetchButton');
            const messageContainer = document.getElementById('messageContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsTableBody = document.getElementById('resultsTableBody');

            // Replace with your actual Supabase URL and key
            const supabaseUrl = 'https://wprgkybgolraukwjexth.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndwcmdreWJnb2xyYXVrd2pleHRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjA5MzAsImV4cCI6MjA3MzIzNjkzMH0.5j9oUoRJNac37pU7MIspfK6Ei4Vol4NnMMCty1adGDA';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            fetchButton.addEventListener('click', async () => {
                const privateId = privateIdInput.value.trim();
                messageContainer.textContent = '';
                resultsContainer.classList.add('hidden');
                resultsTableBody.innerHTML = '';

                if (!privateId) {
                    messageContainer.textContent = 'Please enter a private ID.';
                    messageContainer.classList.remove('text-green-500', 'text-gray-500');
                    messageContainer.classList.add('text-red-500');
                    return;
                }

                messageContainer.textContent = 'Validating private ID...';
                messageContainer.classList.remove('text-red-500', 'text-green-500');
                messageContainer.classList.add('text-gray-500');
                fetchButton.disabled = true;

                try {
                    // First, validate the private ID against the new 'valid_private_ids' table
                    const { data: idData, error: idError } = await supabase
                        .from('valid_private_ids')
                        .select('private_id')
                        .eq('private_id', privateId)
                        .single();
                    
                    if (idError && idError.code === 'PGRST116') { // No rows found
                        messageContainer.textContent = 'Invalid private ID. Please check your ID and try again.';
                        messageContainer.classList.remove('text-green-500', 'text-gray-500');
                        messageContainer.classList.add('text-red-500');
                        return;
                    }
                    if (idError) {
                        throw new Error(idError.message);
                    }

                    // If the ID is valid, proceed to fetch submissions
                    messageContainer.textContent = 'Fetching submissions...';
                    messageContainer.classList.remove('text-red-500', 'text-green-500');
                    messageContainer.classList.add('text-gray-500');
                    
                    const { data, error } = await supabase.rpc('get_user_valid_submissions', {
                        user_private_id: privateId
                    });

                    if (error) {
                        throw new Error(error.message);
                    }

                    if (data && data.length > 0) {
                        messageContainer.textContent = `Found ${data.length} submissions.`;
                        messageContainer.classList.remove('text-red-500', 'text-gray-500');
                        messageContainer.classList.add('text-green-500');
                        resultsContainer.classList.remove('hidden');

                        data.sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at));

                        data.forEach(submission => {
                            const row = document.createElement('tr');
                            row.classList.add('hover:bg-gray-50');

                            const firstSubmissionText = submission.is_first_submission ? 'Yes' : 'No';
                            const firstSubmissionColor = submission.is_first_submission ? 'text-green-600' : 'text-red-600';

                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    ${submission.healthing_code}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${new Date(submission.submitted_at).toLocaleString()}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-semibold ${firstSubmissionColor}">
                                    ${firstSubmissionText}
                                </td>
                            `;
                            resultsTableBody.appendChild(row);
                        });
                    } else {
                        messageContainer.textContent = 'No submissions found for this ID.';
                        messageContainer.classList.remove('text-green-500', 'text-gray-500');
                        messageContainer.classList.add('text-red-500');
                    }

                } catch (err) {
                    console.error('An error occurred:', err);
                    messageContainer.textContent = 'An error occurred. Please try again.';
                    messageContainer.classList.remove('text-green-500', 'text-gray-500');
                    messageContainer.classList.add('text-red-500');
                } finally {
                    fetchButton.disabled = false;
                }
            });
        });
    </script>

</body>
</html>
